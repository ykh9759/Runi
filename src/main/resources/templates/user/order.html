<!DOCTYPE html>
<html lagn="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8" />
    <title>루니웹</title>
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, minimum-scale=1, user-scalable=yes,initial-scale=1.0" />
    <!-- content script -->
    <th:block th:replace="user/include/head :: headFragment"></th:block>
    <!-- index.html 고유 스크립트 추가 -->
    <th:block layout:fragment="script">
        <script th:src="@{/js/script.js}"></script>
        <script th:src="@{/js/order.js}"></script>
    </th:block>
</head>
<body>
    <!-- header fragment 사용 -->
    <!-- <th:block th:replace="include/header :: headerFragment"></th:block> -->
    <!-- content fragment 사용 -->
    <div class="container">
        <div class="row g-5 d-flex justify-content-center">
          <div class="col-md-7 col-lg-8">
            <h4 class="mb-3">주문하기</h4>
            <form method="POST" class="needs-validation" novalidate>
              <div class="row g-3">
                <div class="col-12">
                  <label for="name" class="form-label">이름</label>
                  <input type="text" class="form-control" id="name" name="name" placeholder="홍길동" value="" required>
                  <div class="invalid-feedback">
                    이름을 입력해주세요.
                  </div>
                </div>

                <div class="col-12">
                  <label for="phone" class="form-label">휴대폰번호</label>
                  <input type="text" class="form-control" id="phone" name="phone" placeholder="010-1111-1111">
                  <div class="invalid-feedback">
                    휴대폰번호를 입력해주세요.
                  </div>
                </div>
    
                <div class="col-12">
                  <label for="email" class="form-label">이메일</label>
                  <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com">
                  <div class="invalid-feedback">
                    이메일을 입력해주세요.
                  </div>
                </div>
    
                <div class="col-12">
                  <label for="address" class="form-label">주소</label>
                  <input type="text" class="form-control" id="address" placeholder="서울시 강남구 압구정로 ~" required>
                  <div class="invalid-feedback">
                    주소를 입력해주세요.
                  </div>
                </div>

                <div class="col-12">
                  <label for="account_name" class="form-label">입금자명</label>
                  <input type="text" class="form-control" id="account_name" name="accountName" placeholder="홍길동">
                  <div class="invalid-feedback">
                    입금자명을 입력해주세요.
                  </div>
                </div>

                <hr class="my-4">
                <p>상품목록</p>
                <select class="form-select" onchange="selectProduct(this)">
                  <option selected>선택</option>
                  <th:blocl th:each="product : ${products}">
                    <option th:value="${product.no}" th:text="${product.productName}"></option>
                  </th:blocl>
                </select>

                <div id="orderList">
                </div>
                
                <div class="col-12 row">
                  <div class="col-7 text-start"></div>
                  <div class="col-5 d-flex justify-content-end">
                    <label for="cnt" class="col-4 col-form-label">총 금액:</label>
                    <div class="col-3" id="totalCnt"></div>
                  </div>
                </div>

                <hr class="my-4">

                <div class="form-check">
                  <p>배송 방식</p>
                  <input type="checkbox" class="form-check-input" id="normalParcel" name="parcel" value="1" onclick="checkOnlyOne(this)">
                  <label class="form-check-label" for="save-info">일반택배</label>
                </div>

                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="halfParcel" name="parcel" value="2" onclick="checkOnlyOne(this)"> 
                  <label class="form-check-label" for="save-info">반값택배</label>
                </div>
    
    
                <hr class="my-4">
      
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="cashReceipts" name="cashReceipts" value="1">
                  <label class="form-check-label" for="same-address">현금영수증</label>
                </div>
    
      
                <hr class="my-4">
  
                <button class="w-100 btn btn-primary btn-lg" type="submit">주문하기</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    <!-- footer fragment 사용 -->
    <th:block th:replace="user/include/footer :: footerFragment"></th:block>

<th:block th:replace="user/include/script :: scriptFragment"></th:block>
<script th:inline="javascript">

  //상품내역
  var products = Object.values([[${products}]]);

  //선택함 삼품 가져오는 함수
  function searchObj(obj, searchValue) {

    let result = null;

    for (let key in obj) {

      const val = obj[key];

      if (val.no == searchValue) {

        result = obj[key];
        break;
      }
    }

    return result;
  }

  //상품 선택
  function selectProduct(obj) {

    const no = obj.value;

    //선택된 항목은 선택 못하게
    const productId = document.getElementById('price-'+no);
    if(productId) {

      Swal.fire({
            text: "이미 선택한 상품입니다.",
            icon: 'warning',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '확인',
        });

      return;
    }

    //선택한 상품 값 가져오기
    const value = searchObj(products, no);

    const orderList = document.getElementById('orderList');

    // let str = '';
    // str += '<div id="product-'+no+'" class="col-12 row mt-10">';
    // str += '<input type="hidden" class="form-control" name="productNo" value="'+no+'">';
    // str += '<div class="col-7 text-start">';
    // str += '<span>'+value.productName+'</span>'
    // str += '</div>'
    // str += '<div class="col-7">';
    // str += '<div class="input-group">';
    // str += '<button type="button" class="btn btn-primary" onclick="plusMinus(\'M\','+no+')"><i class="fas fa-minus"></i></button>';
    // str += '<div class="col-sm-2" id="input-'+no+'">';
    // str += '<input type="text" class="form-control" id="cnt-'+no+'" name="cnt-'+no+'" value="1">';
    // str += '</div>';
    // str += '<button type="button" class="btn btn-primary" onclick="plusMinus(\'P\','+no+')"><i class="fas fa-plus"></i></button>';
    // str += '</div>';
    // str += '</div>';
    // str += '<div class="col-5 d-flex justify-content-end">';
    // str += '<span id="price-'+no+'">'+value.price+'</span>원';
    // str += '</div>';
    // str += '<hr class="my-4">';
    // str += '</div>';

    // orderList.innerHTML += str;

    const div1 = document.createElement('div');
    div1.classList.add('col-12', 'row', 'mt-10');
    const div2 = document.createElement('div');
    div2.classList.add('col-7', 'text-start');
    const span1 = document.createElement('span');
    span1.textContent = value.productName;
    const div3 = document.createElement('div');
    div3.classList.add('col-7');
    const div4 = document.createElement('div');
    div4.classList.add('input-group');
    const button1 = document.createElement('button');
    button1.classList.add('btn', 'btn-primary');
    button1.setAttribute('onClick', 'plusMinus(\'M\','+no+')');
    button1.type = 'button';
    const i1 = document.createElement('i');
    i1.setAttribute('class', 'fas fa-minus');
    const div5 = document.createElement('div');
    div5.classList.add('col-sm-2');
    const input1 = document.createElement('input');
    input1.classList.add('form-control');
    input1.id = 'cnt-'+no;
    input1.type = 'text';
    input1.value = '1';
    const button2 = document.createElement('button');
    button2.classList.add('btn', 'btn-primary');
    button2.setAttribute('onClick', 'plusMinus(\'P\','+no+')');
    button2.type = 'button';
    const i2 = document.createElement('i');
    i2.setAttribute('class', 'fas fa-plus');
    const div6 = document.createElement('div');
    div6.setAttribute('class', 'col-5 d-flex justify-content-end');
    const span2 = document.createElement('span');
    span2.textContent = value.price;
    span2.setAttribute('id','price-'+no);
    const hr1 = document.createElement('hr');
    hr1.setAttribute('class','my-4');

    div1.appendChild(div2);
    div2.appendChild(span1);
    div3.appendChild(div4);
    div4.appendChild(button1);
    div4.appendChild(div5);
    div5.appendChild(input1);
    div4.appendChild(button2);
    div6.appendChild(span2);
    button1.appendChild(i1);
    button2.appendChild(i2);
    orderList.appendChild(div1);
    div1.appendChild(div3);
    div1.appendChild(div6);
    div1.appendChild(hr1);

    obj.selectedIndex = 0;
  
  }

  function plusMinus(div, no) {

    let cnt = parseInt(document.getElementById('cnt-'+no).value);
    let price = parseInt(document.getElementById('price-'+no).innerHTML);

    cnt = isNaN(cnt) ? 0 : cnt;

    price = price/cnt;

    if(div=='P') {
      cnt++;


    } else if(div=='M') {

      cnt--;
    }
    
    price = price * cnt;

    if(cnt < 1) return false;

    document.getElementById('cnt-'+no).value = cnt;
    document.getElementById('price-'+no).innerHTML = price;

  }
  
</script>
</body>
</html>